<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vibluna</title>
  <style>
    :root{
      --bg:#0b0b14; --panel:#0e0b1f; --card:#121027; --muted:#8fa7c6; --text:#0c1220; --accent:#0ea5e9; --accent-2:#38bdf8;
      --ok:#35C46E; --warn:#F59E0B; --err:#EF4444; --border:#cfe4f9; --fit:cover;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;color:var(--text);
         background:radial-gradient(1200px 700px at 20% -10%, #13112e 0%, #0b0b14 60%);} 
    a{color:var(--accent)}
    header{position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:12px;
      padding:12px 14px;background:rgba(10,14,28,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .brand{font-weight:800;letter-spacing:.3px;font-size:16px;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent} .logo{display:grid;place-items:center;width:28px;height:28px} .logo svg{display:block}
    .tabs{display:flex;gap:6px;margin-left:auto}
    .tab{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:13px}
    .tab.active{outline:1px solid rgba(14,165,233,.35);background:linear-gradient(180deg,#1a102a,#151233)}
    .pill{font-size:12px;border:1px solid var(--border);background:#0e1426;padding:6px 10px;border-radius:999px}
    .pill.ok{color:#caffde;border-color:#285a3f;background:#0d1d15}
    .pill.err{color:#ffd1d1;border-color:#5a2828;background:#1d0d0d}
    .container{padding:14px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input, select, button, textarea, .toggle{background:#0f1424;color:var(--text);border:1px solid #2a3350;border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
    textarea{width:100%;min-height:90px}
    input[type="checkbox"]{transform:scale(1.05)}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg, var(--accent), #0284c7);border-color:#7dd3fc}
    button.ghost{background:#0f1424}
    button:hover{border-color:#3b4b6e}
    .help{font-size:12px;color:var(--muted)}
    .alert{border:1px solid #442525;background:#1a0f10;color:#ffb4b4;padding:10px;border-radius:10px;display:none}
    .success{border:1px solid #1f3c2c;background:#0f1a14;color:#caffe0;padding:10px;border-radius:10px;display:none}

    /* TikTok-like feed */
    .feed-wrap{display:flex;justify-content:center}
    .phone{position:relative;width:min(420px, 95vw);height:calc(100vh - 160px);border:1px solid var(--border);border-radius:22px;overflow:hidden;background:#05070f;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    .reels{height:100%;overflow-y:auto;scroll-snap-type:y mandatory}
    .reel{position:relative;height:100%;scroll-snap-align:start;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#060814,#0a0c12)}
    .reel video{width:100%;height:100%;object-fit:var(--fit);display:block}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .caption{position:absolute;left:12px;bottom:12px;right:84px;font-size:14px;line-height:1.35}
    .caption .user{font-weight:700}
    .caption .meta{color:#cbd5e1;font-size:12px;opacity:.9}
    .actions{position:absolute;right:10px;bottom:12px;display:flex;flex-direction:column;gap:14px;align-items:center}
    .btn-ico{pointer-events:auto;border:1px solid #243052;background:#0c1221;border-radius:999px;width:48px;height:48px;display:grid;place-items:center}
    .btn-ico:hover{border-color:#3c4f7e}
    .count{font-size:11px;color:#cbd5e1;text-align:center}
    .topbar{position:absolute;left:8px;top:8px;display:flex;gap:6px;align-items:center}
    .topbar .badge{font-size:11px;border:1px solid #324064;background:#12182a;color:#b5c7ff;padding:2px 8px;border-radius:999px}
    .mute{position:absolute;left:10px;top:10px;pointer-events:auto}

    .drawer{position:absolute;left:0;right:0;bottom:0;max-height:70%;background:rgba(10,14,28,.96);border-top:1px solid var(--border);transform:translateY(100%);transition:transform .28s ease;display:flex;flex-direction:column}
    .drawer.open{transform:translateY(0)}
    .drawer header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
    .drawer .body{padding:10px 12px;gap:8px;display:flex;flex-direction:column}

    footer{padding:8px 12px;color:#8a94a6;font-size:11px;text-align:center;border-top:1px solid var(--border);margin-top:12px}

    @media (max-height:720px){ .phone{height:calc(100vh - 140px);} }
    /* Light theme overrides */
    body.light{ --bg:#f0f9ff; --panel:#ffffff; --card:#ffffff; --muted:#0c4a6e; --text:#0c1220; --accent:#0ea5e9; --accent-2:#38bdf8; --border:#e0f2fe; }
    body.light header{ background:#ffffff; border-bottom:1px solid var(--border); }
    body.light .panel{ background:var(--panel); border-color:var(--border); }
    body.light .pill{ background:#f1f5f9; border-color:#var(--border); color:#0c1220 }
    body.light button.ghost{ background:#f8fafc; border-color:#var(--border); color:#0c1220 }
    body.light .tab.active{ outline:1px solid rgba(14,165,233,.35); background:linear-gradient(180deg,#f9fafb,#eef2ff) }
  /* Light theme extra overrides */
    body.light { background: radial-gradient(1200px 700px at 20% -10%, #f0f9ff 0%, #e0f2fe 60%); }
    body.light header{ background:#ffffff; border-bottom:1px solid var(--border); }
    body.light .panel{ background:var(--panel); border-color:var(--border); }
    body.light .pill{ background:#f1f5f9; border-color:#var(--border); color:#0c1220 }
    body.light input, body.light select, body.light textarea, body.light .toggle{ background:#ffffff; color:#0c1220; border:1px solid var(--border); }
    body.light button.ghost{ background:#f8fafc; border-color:#var(--border); color:#0c1220 }
    body.light button.primary{ border-color:#a7f3d0 }
    body.light .tab{ background:#ffffff; color:#0c1220; }
    body.light .tab.active{ outline:1px solid rgba(14,165,233,.35); background:linear-gradient(180deg,#f9fafb,#eef2ff) }
    body.light .phone{ background:#ffffff; border-color:var(--border); box-shadow:0 8px 24px rgba(0,0,0,.12); }
    body.light .reel{ background: linear-gradient(180deg,#f4f7ff,#f8fbff); }
    body.light .btn-ico{ background:#f9fafb; border-color:#d1d5db }
    body.light .caption .meta, body.light .count{ color:#64748b }
    body.light .topbar .badge{ border-color:#bae6fd; background:#e0f2fe; color:#0c4a6e }
  /* Professional search bar */
    .searchbar{display:flex;align-items:center;background:#ffffff;border:1px solid var(--border);border-radius:999px;padding:4px 6px;gap:6px;box-shadow:0 2px 8px rgba(2,132,199,.06)}
    .searchbar input{flex:1;border:0;background:transparent;padding:10px 12px;outline:none;color:var(--text)}
    .searchbar input::placeholder{color:var(--muted)}
    .searchbar button{border:0;border-radius:999px;background:linear-gradient(180deg,var(--accent),#0284c7);padding:8px 10px;display:grid;place-items:center;cursor:pointer}
    .searchbar button svg{stroke:#fff}
    .searchbar:focus-within{box-shadow:0 0 0 3px rgba(14,165,233,.25)}
    /* Profile visuals */
    .avatar{width:56px;height:56px;border-radius:999px;background:linear-gradient(180deg,var(--accent-2),var(--accent));display:grid;place-items:center;color:#fff;font-weight:800}
    .avatar.sm{width:36px;height:36px;font-size:12px}
    .card-sm{border:1px solid var(--border);background:var(--panel);border-radius:12px;padding:10px}
    .grid-sm{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .avatar-img{width:56px;height:56px;border-radius:999px;object-fit:cover;border:2px solid var(--border);display:none}
  .pill.status{display:none !important}
  /* Profile menu */
    .menu{position:relative}
    .menu .kebab{width:36px;height:36px;border-radius:10px;display:grid;place-items:center}
    .dropdown{position:absolute;top:40px;right:0;background:var(--panel);border:1px solid var(--border);border-radius:12px;min-width:180px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:10}
    .dropdown.open{display:block}
    .dropdown .item{padding:10px 12px;cursor:pointer;display:flex;gap:8px;align-items:center}
    .dropdown .item:hover{background:rgba(2,132,199,.08)}
    .hidden{display:none}
  /* Header mini profile */
    .hprof{display:flex;align-items:center;position:relative;margin-left:8px}
    .hprof-btn{display:flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px}
    .mini-img{width:28px;height:28px;border-radius:999px;object-fit:cover;display:none;border:1px solid var(--border)}
    .mini-name{font-size:13px;color:var(--text)}
  </style>
</head>
<body class="light">
  <header>
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 64 64" width="28" height="28" role="img" aria-label="Vibluna logo">
        <defs>
          <linearGradient id="vib" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="var(--accent)"/>
            <stop offset="100%" stop-color="var(--accent-2)"/>
          </linearGradient>
        </defs>
        <rect x="6" y="6" width="52" height="52" rx="14" fill="url(#vib)"/>
        <path d="M20 42 L28 22 L34 34 L44 22" stroke="#fff" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polygon points="30,30 46,32 30,38" fill="#fff" opacity=".9"/>
      </svg>
    </div>
    <div class="brand">Vibluna</div>
    <span class="pill status" id="userPill" aria-hidden="true"></span>
    <span class="pill status" id="modePill" aria-hidden="true"></span>
    <div class="searchbar" style="flex:1;max-width:560px;margin-left:12px;margin-right:8px">
      <input id="headerQ" placeholder="Search videos…">
      <button onclick="headerSearch()" aria-label="Search">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </button>
    </div>
    <button class="ghost" style="margin-left:8px" onclick="toggleTheme()" title="Toggle light/dark">☀︎/🌙</button>
    <div class="menu hprof" id="hprof">
      <button class="ghost hprof-btn" onclick="toggleMiniMenu(event)" title="Account">
        <img id="mini-photo" class="mini-img" alt="Profile" />
        <div id="mini-avatar" class="avatar sm">VB</div>
        <span id="mini-name" class="mini-name">@guest</span>
        <span class="dots">⋮</span>
      </button>
      <div class="dropdown" id="mini-menu">
        <div class="item" id="mm-open-profile" onclick="setView('profile', document.querySelector('[data-view=\\'profile\\']')); hideMiniMenu();">Open Profile</div>
        <div class="item" id="mm-change-photo" onclick="triggerAvatarFile(); hideMiniMenu();">Change photo</div>
        <div class="item" id="mm-login" onclick="setView('auth', document.querySelector('[data-view=\\'auth\\']')); hideMiniMenu();">Login / Signup</div>
        <div class="item" id="mm-logout" onclick="clearToken(); hideMiniMenu();">Logout</div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" data-view="feed" onclick="setView('feed', this)">Feed</button>
      <button class="tab" data-view="upload" onclick="setView('upload', this)">Upload (Creator)</button>
    </div>
  </header>

  <div class="container">
    <div class="panel toolbar">
      <div class="row">
        <label class="toggle" title="Enable to query your running FastAPI backend">
          <input id="liveToggle" type="checkbox" onchange="toggleLive()" /> Use Live API
        </label>
        <input id="apiUrl" type="url" value="http://127.0.0.1:8000" placeholder="API base URL (e.g., http://127.0.0.1:8000)" style="flex:1" />
        <select id="fitSel" onchange="setFit(this.value)"><option value="cover">Fill (9:16)</option><option value="contain">Contain</option></select>
        <button class="ghost" onclick="testConnection()">Test</button>
        <button class="ghost" onclick="seedDemo()">Seed demo</button>
        <button class="ghost" onclick="clearToken()">Logout</button>
      </div>
      <div id="alert" class="alert"></div>
      <div id="success" class="success"></div>
      <div class="help">Live mode calls: <code>/videos/latest</code> or <code>/videos/search</code>, <code>/login</code>, <code>/signup</code>, and <code>/videos/upload</code>. The feed auto-plays the focused video like TikTok. Use ↑/↓ to jump between videos.</div>
    </div>

    <section id="view-feed">
      <div class="panel" style="display:flex;align-items:center;justify-content:space-between">
        <div class="searchbar" style="flex:1">
          <input id="q" type="search" placeholder="Search videos… (empty = latest)" onkeyup="if(event.key==='Enter') reloadFeed()" />
          <button onclick="reloadFeed()" aria-label="Search">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          </button>
        </div>
        <div class="help" id="count" style="margin-left:8px">0 results</div>
      </div>
      <div class="feed-wrap">
        <div class="phone">
          <div class="reels" id="reels"></div>
        </div>
      </div>
      <footer>Hint: Use the <b>Upload</b> tab to add an MP4 (creator account), then return to the Feed in Live mode.</footer>
    </section>

    <section id="view-auth" style="display:none">
      <div class="panel two-col">
        <div>
          <h3>Signup</h3>
          <div class="row"><input id="su_username" placeholder="username (@handle)" style="flex:1"></div>
          <div class="row"><input id="su_password" placeholder="password" type="password" style="flex:1"></div>
          <div class="row">
            <button class="primary" onclick="signup()">Create Account</button>
          </div>
          <div class="help">Creates a <b>consumer</b> with <b>username (@handle)</b> and <b>password</b>. Creator accounts are <b>admin-enrolled</b>; no public creator signup.</div>
        </div>
        <div>
          <h3>Login</h3>
          <div class="row"><input id="li_username" placeholder="username" style="flex:1"></div>
          <div class="row"><input id="li_password" placeholder="password" type="password" style="flex:1"></div>
          <div class="row">
            <button class="primary" onclick="login()">Login</button>
          </div>
          <div class="help">Retrieves a JWT via <code>POST /login</code> and stores it locally for subsequent calls.</div>
        </div>
      </div>
    </section>

    <section id="view-profile" style="display:none">
      <div class="panel">
        <div class="row" style="align-items:center">
          <div style="position:relative">
            <div class="avatar" id="pf-avatar">VS</div>
            <img id="pf-photo" class="avatar-img" alt="Profile photo" />
          </div>
          <div>
            <div id="pf-username" style="font-weight:700">@guest</div>
            <div class="help" id="pf-id">id: —</div>
            <div class="help" id="pf-role">role: —</div>
          </div>
          <div class="menu" style="margin-left:auto">
            <button class="ghost kebab" onclick="toggleProfileMenu(event)" aria-label="Profile menu">⋮</button>
            <div class="dropdown" id="pf-menu">
              <div class="item" onclick="triggerAvatarFile()">Change photo</div>
              <div class="item" onclick="copyProfileId()">Copy ID</div>
              <div class="item" onclick="refreshProfile()">Refresh</div>
              <div class="item" onclick="clearToken()">Logout</div>
            </div>
            <input id="pf-file" type="file" accept="image/*" class="hidden" onchange="uploadAvatarFromInput()" />
          </div>
        </div>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">My uploads</h3>
        <div id="pf-uploads" class="grid-sm"></div>
        <div class="help" id="pf-empty" style="display:none">No uploads yet. If you're a creator, go to the <b>Upload</b> tab to add your first video.</div>
      </div>
    </section>

    <section id="view-upload" style="display:none">
      <div class="panel">
        <h3>Upload Video (Creators)</h3>
        <div class="help">Log in as <b>creator</b> in Live mode. File type: MP4.</div>
        <div class="two-col">
          <div>
            <div class="row"><input id="v_title" placeholder="Title" style="flex:1"></div>
            <div class="row"><input id="v_publisher" placeholder="Publisher" style="flex:1"></div>
            <div class="row"><input id="v_producer" placeholder="Producer" style="flex:1"></div>
          </div>
          <div>
            <div class="row"><input id="v_genre" placeholder="Genre (e.g., Promo)" style="flex:1"></div>
            <div class="row"><input id="v_age" placeholder="Age Rating (PG, 18)" style="flex:1"></div>
            <div class="row"><input id="v_file" type="file" accept="video/mp4" style="flex:1"></div>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="primary" onclick="uploadVideo()">Upload</button>
          <button class="ghost" onclick="clearUploadForm()">Clear</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const sample = [
      {id:1,title:"Demo Launch",publisher:"You",producer:"You",genre:"Promo",age_rating:"PG",filename:"demo.mp4",src:"https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"},
      {id:2,title:"Campus Vibes",publisher:"Studio X",producer:"Mia K.",genre:"Music",age_rating:"PG",filename:"campus.mp4",src:"https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4"},
      {id:3,title:"Quick Python Tips",publisher:"DevDaily",producer:"A. Rahman",genre:"Education",age_rating:"G",filename:"python.mp4",src:"https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4"},
      {id:4,title:"Standup Night",publisher:"LaughHub",producer:"Jay P.",genre:"Comedy",age_rating:"PG-13",filename:"standup.mp4",src:"https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4"}
    ];

    let useLive = false;
    let token = localStorage.getItem('video_app_token') || '';
    let user = null;
    let items = [];
    let observer = null;

    function setPill(ok, msg){
      const pill = document.getElementById('modePill');
      pill.textContent = msg;
      pill.className = 'pill ' + (ok===true? 'ok' : ok===false? 'err': '');
    }
    function setUserPill(text){ document.getElementById('userPill').textContent = text; }
    function setFit(val){ document.documentElement.style.setProperty('--fit', val || 'cover'); }

    function alertMsg(text){
      const el = document.getElementById('alert');
      if(!text){ el.style.display='none'; el.textContent=''; return; }
      el.style.display='block';
      el.textContent = text;
    }
    function successMsg(text){
      const el = document.getElementById('success');
      if(!text){ el.style.display='none'; el.textContent=''; return; }
      el.style.display='block';
      el.textContent = text;
      setTimeout(()=>{ el.style.display='none'; }, 3000);
    }

    function apiBase(){
      let u = document.getElementById('apiUrl').value;
      if(u.endsWith('/')) u = u.slice(0, -1);
      return u;
    }

    async function testConnection(){
      try{
        alertMsg('');
        const res = await fetch(apiBase() + '/healthz');
        if(!res.ok) throw new Error('HTTP ' + res.status);
        setPill(true, 'Live API ✓');
        if(token) await refreshProfile();
      }catch(e){
        setPill(false, 'Live API ✗');
        alertMsg('Cannot reach ' + apiBase() + '/healthz — Is the backend running?');
      }
    }

    function toggleLive(){
      useLive = document.getElementById('liveToggle').checked;
      if(useLive){ testConnection(); } else { setPill(null, 'Mock data'); alertMsg(''); }
      reloadFeed();
    }

    function matches(q, v){
      if(!q) return true;
      q = q.toLowerCase();
      return (
        (v.title||'').toLowerCase().includes(q) ||
        (v.publisher||'').toLowerCase().includes(q) ||
        (v.producer||'').toLowerCase().includes(q) ||
        (v.genre||'').toLowerCase().includes(q)
      );
    }

    async function getData(){
      const q = document.getElementById('q').value.trim();
      if(!useLive){
        let rows = sample.slice();
        if(q) rows = rows.filter(v => matches(q, v));
        return rows;
      }
      try{
        alertMsg('');
        const url = q ? apiBase()+"/videos/search?q="+encodeURIComponent(q) : apiBase()+"/videos/latest";
        const res = await fetch(url);
        if(!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      }catch(e){
        alertMsg('Fetch failed: ' + e.message + '. Ensure CORS is enabled and URL is correct.');
        return [];
      }
    }

    function ico(path){ return "<svg viewBox='0 0 24 24' width='22' height='22' fill='none' stroke='#dbe5ff' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'><path d='"+path+"'/></svg>" }

    function buildReel(v, idx){
      const src = useLive ? ((v.url && v.url.length) ? v.url : (apiBase()+"/media/"+(v.filename||''))) : (v.src || '');
      const el = document.createElement('section');
      el.className = 'reel';
      const publisherHandle = (v.publisher||'user').toLowerCase().split(' ').join('');
      el.innerHTML = `
        <video playsinline muted loop preload="metadata" data-idx="${idx}">
          <source src="${src}" type="video/mp4" />
        </video>
        <div class="overlay">
          <div class="topbar"><span class="badge">${v.genre||'—'}</span><span class="badge">Age: ${v.age_rating||'—'}</span></div>
          <button class="pill mute" onclick="toggleMute(this)" title="Mute / Unmute" style="pointer-events:auto">🔇</button>
          <div class="caption">
            <div class="user">@${publisherHandle}</div>
            <div>${v.title||'(no title)'} — <span class="meta">by ${v.producer||'-'}</span></div>
          </div>
          <div class="actions">
            <button class="btn-ico" onclick="like(${idx}, this)" title="Like">${ico('20.84 4.61c-2.28-2.28-5.98-2.28-8.26 0l-.58.58-.58-.58c-2.28-2.28-5.98-2.28-8.26 0-2.28 2.28-2.28 5.98 0 8.26l8.84 8.84 8.84-8.84c2.28-2.28 2.28-5.98 0-8.26z')}</button>
            <div class="count" id="like-${idx}">0</div>
            <button class="btn-ico" onclick="openComments(${idx})" title="Comment">${ico('21 15v4a2 2 0 0 1-2 2H7l-4 4V6a2 2 0 0 1 2-2h9')}</button>
            <button class="btn-ico" onclick="share(${idx})" title="Share">${ico('4 12h16M12 4v16')}</button>
          </div>
        </div>
        <div class="drawer" id="drawer-${idx}">
          <header>
            <strong>Comments & Rating</strong>
            <button class="ghost" onclick="closeComments(${idx})">Close</button>
          </header>
          <div class="body">
            <textarea id="comment-${idx}" placeholder="Write a comment…"></textarea>
            <div class="row">
              <button class="primary" onclick="sendComment(${idx}, ${v.id||0})">Post</button>
              <span class="help">Posts to <code>/videos/${v.id||':id'}/comment</code> (requires login).</span>
            </div>
            <div class="row">
              <div class="help">Rating: <span id="rating-sum-${idx}">—</span></div>
            </div>
            <div class="row">
              <div class="help">Rate:</div>
              <div>
                <button class="ghost" onclick="rateVideo(${idx}, ${v.id||0}, 1)">⭐</button>
                <button class="ghost" onclick="rateVideo(${idx}, ${v.id||0}, 2)">⭐</button>
                <button class="ghost" onclick="rateVideo(${idx}, ${v.id||0}, 3)">⭐</button>
                <button class="ghost" onclick="rateVideo(${idx}, ${v.id||0}, 4)">⭐</button>
                <button class="ghost" onclick="rateVideo(${idx}, ${v.id||0}, 5)">⭐</button>
              </div>
              <span class="help">Sends to <code>/videos/${v.id||':id'}/rate</code> (requires login).</span>
            </div>
          </div>
        </div>
      `;
      return el;
    }

    function setupObserver(){
      if(observer) observer.disconnect();
      observer = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          const video = entry.target.querySelector('video');
          if(!video) return;
          if(entry.isIntersecting && entry.intersectionRatio > 0.6){
            document.querySelectorAll('.reel video').forEach(v=>{ if(v!==video){ v.pause(); }});
            video.play().catch(()=>{});
          }else{
            video.pause();
          }
        });
      }, {threshold:[0,0.6,1]});
      document.querySelectorAll('.reel').forEach(r=>observer.observe(r));
    }

    async function reloadFeed(){
      const reels = document.getElementById('reels');
      reels.innerHTML = '';
      items = await getData();
      document.getElementById('count').textContent = `${items.length} result${items.length!==1?'s':''}`;
      items.forEach((v,i)=> reels.appendChild(buildReel(v,i)) );
      setupObserver();
      const first = document.querySelector('.reel video');
      if(first){ first.play().catch(()=>{}); }
    }

    function headerSearch(){ const v=document.getElementById('headerQ').value.trim(); document.getElementById('q').value=v; reloadFeed(); }
    function toggleTheme(){ document.body.classList.toggle('light'); }

    document.addEventListener('keydown', (e)=>{
      if(document.getElementById('view-feed').style.display==='none') return;
      const reels = Array.from(document.querySelectorAll('.reel'));
      const pos = reels.findIndex(r=>{
        const rect = r.getBoundingClientRect();
        return rect.top>=0 && rect.top<window.innerHeight*0.5;
      });
      if(e.key==='ArrowDown' && pos<reels.length-1){ reels[pos+1].scrollIntoView({behavior:'smooth'}); }
      if(e.key==='ArrowUp' && pos>0){ reels[pos-1].scrollIntoView({behavior:'smooth'}); }
    });

    function toggleMute(btn){
      const reel = btn.closest('.reel');
      const v = reel.querySelector('video');
      v.muted = !v.muted;
      btn.textContent = v.muted ? '🔇' : '🔊';
      if(!v.paused) v.play().catch(()=>{});
    }

    function like(idx, btn){
      const el = document.getElementById('like-'+idx);
      el.textContent = String((parseInt(el.textContent)||0)+1);
      btn.style.outline = '2px solid #ff5a8b';
      setTimeout(()=>btn.style.outline='none', 400);
    }

    function openComments(idx){ document.getElementById('drawer-'+idx).classList.add('open'); loadDrawer(idx); }
    function closeComments(idx){ document.getElementById('drawer-'+idx).classList.remove('open'); }

    async function sendComment(idx, videoId){
      if(!useLive) return alertMsg('Enable Live API to post comments.');
      if(!token) return alertMsg('Login first.');
      try{
        const text = (document.getElementById('comment-'+idx).value||'').trim();
        if(!text) return;
        const res = await fetch(apiBase()+"/videos/"+videoId+"/comment", {
          method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({text})
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        successMsg('Comment posted');
        document.getElementById('comment-'+idx).value='';
      }catch(e){ alertMsg('Comment failed: '+e.message); }
    }

    async function rateVideo(idx, videoId, score){
      if(!useLive) return alertMsg('Enable Live API to rate.');
      if(!token) return alertMsg('Login first.');
      try{
        const res = await fetch(apiBase()+`/videos/${videoId}/rate`, {
          method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({score})
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        successMsg('Thanks for rating!');
      }catch(e){ alertMsg('Rating failed: '+e.message); }
    }

    function share(idx){
      navigator.clipboard && navigator.clipboard.writeText(location.href).then(()=>successMsg('Link copied')).catch(()=>successMsg('Share triggered'));
    }

    async function signup(){
      if(!useLive) return alertMsg('Enable Live API to call /signup');
      try{
        const body = {
          username: document.getElementById('su_username').value.trim(),
          password: document.getElementById('su_password').value,
          role: 'consumer'
        };
        const res = await fetch(apiBase()+"/signup", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        successMsg('Signup successful. You can now log in.');
      }catch(e){ alertMsg('Signup failed: ' + e.message); }
    }

    async function login(){
      if(!useLive) return alertMsg('Enable Live API to call /login');
      try{
        const body = {
          username: document.getElementById('li_username').value.trim(),
          password: document.getElementById('li_password').value
        };
        const res = await fetch(apiBase()+"/login", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        token = data.access_token || '';
        localStorage.setItem('video_app_token', token);
        successMsg('Logged in. Token stored.');
        await refreshProfile();
      }catch(e){ alertMsg('Login failed: '+e.message); }
    }

    async function fetchMe(){ return refreshProfile(); }

    function clearToken(){ token=''; localStorage.removeItem('video_app_token'); user=null; document.getElementById('userPill').textContent='Not logged in'; successMsg('Logged out.'); renderMiniProfile(); clearMiniPhoto(); }

    function initials(name){ name = (name||'VS').toUpperCase(); return (name[0]||'V') + (name[1]||'S'); }
    function renderProfileHeader(){
      const un = (user && user.username) ? user.username : 'guest';
      const role = (user && user.role) ? user.role : '—';
      const av = document.getElementById('pf-avatar'); if(av) av.textContent = initials(un);
      const uel = document.getElementById('pf-username'); if(uel) uel.textContent = '@'+un;
      const rel = document.getElementById('pf-role'); if(rel) rel.textContent = 'role: '+role;
    }
    async function loadProfile(){
      renderProfileHeader();
      const grid = document.getElementById('pf-uploads');
      const empty = document.getElementById('pf-empty');
      if(!grid) return;
      grid.innerHTML = '';
      let rows = [];
      if(user){
        if(useLive){
          try{
            const res = await fetch(apiBase()+"/videos/search?q="+encodeURIComponent(user.username));
            rows = res.ok ? await res.json() : [];
          }catch(_){ rows = []; }
        }else{
          rows = sample.slice();
        }
        rows = rows.filter(v => (v.publisher||'').toLowerCase().includes(user.username.toLowerCase()));
      }
      if(!user){ empty.style.display='block'; empty.textContent='Login to see your profile.'; return; }
      if(rows.length===0){ empty.style.display='block'; return; } else { empty.style.display='none'; }
      for(const v of rows){
        const card = document.createElement('div'); card.className='card-sm';
        const src = useLive ? ((v.url && v.url.length) ? v.url : (apiBase()+"/media/"+(v.filename||''))) : (v.src||'');
        card.innerHTML = `<div class="row" style="align-items:center;gap:10px"><div class="avatar sm">${initials(v.publisher||'VS')}</div><div style="flex:1"><div style="font-weight:600">${v.title||'(untitled)'}</div><div class="help">${v.genre||''} · Age: ${v.age_rating||''}</div></div><a class="pill" style="text-decoration:none" href="#" onclick="playFromProfile('${src}')">Play</a></div>`;
        grid.appendChild(card);
      }
    }
    function playFromProfile(url){
      setView('feed', document.querySelector('[data-view="feed"]'));
    }

    function clearUploadForm(){ ['v_title','v_publisher','v_producer','v_genre','v_age','v_file'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); prefillUpload(); }
    function prefillUpload(){
      const pub = document.getElementById('v_publisher'); if(!pub) return;
      if(user && user.role && user.role.toLowerCase()==='creator'){
        pub.value = '@'+user.username; pub.readOnly = true; pub.title = 'Publisher is your handle';
      }else{ pub.readOnly = false; pub.title=''; }
    }

    async function uploadVideo(){
      if(!useLive) return alertMsg('Enable Live API to upload.');
      if(!token) return alertMsg('Log in as creator first.');
      try{
        const fd = new FormData();
        fd.append('title', document.getElementById('v_title').value.trim());
        fd.append('publisher', document.getElementById('v_publisher').value.trim());
        fd.append('producer', document.getElementById('v_producer').value.trim());
        fd.append('genre', document.getElementById('v_genre').value.trim());
        fd.append('age_rating', document.getElementById('v_age').value.trim());
        const file = document.getElementById('v_file').files[0];
        if(!file) return alertMsg('Choose an MP4 file.');
        fd.append('file', file);
        const res = await fetch(apiBase()+"/videos/upload", { method:'POST', headers: { 'Authorization': 'Bearer '+token }, body: fd });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        successMsg('Upload successful: #'+data.id+' — '+(data.title||''));
        clearUploadForm();
        setView('feed', document.querySelector('[data-view="feed"]'));
      }catch(e){ alertMsg('Upload failed: '+e.message); }
    }

    async function seedDemo(){
      if(!useLive) return alertMsg('Enable Live API first.');
      try{
        const res = await fetch(apiBase()+"/dev/seed", {method:'POST'});
        if(!res.ok){ throw new Error('HTTP '+res.status); }
        const data = await res.json();
        successMsg('Seeded: '+data.videos_added+' videos. Users: admin, creator_demo, consumer_demo');
        reloadFeed();
      }catch(e){ alertMsg('Seed failed: '+e.message+' (set ALLOW_DEV_SEED=true in backend env)'); }
    }

    (function init(){
      if(token){ document.getElementById('userPill').textContent='Token loaded'; } else { document.getElementById('userPill').textContent='Not logged in'; }
      setView('feed', document.querySelector('[data-view="feed"]'));
    })();

    function fmt(n){return (Math.round(n*100)/100).toFixed(2)}
    async function loadDrawer(idx){
      const v = items[idx] || {}; const vid = v.id||0;
      if(!useLive || !vid) return;
      try{
        const r = await fetch(apiBase()+`/videos/${vid}/rating`);
        if(r.ok){ const s = await r.json(); const el=document.getElementById(`rating-sum-${idx}`); if(el) el.textContent = `${fmt(s.average)} (${s.count})`; }
        const c = await fetch(apiBase()+`/videos/${vid}/comments`);
        if(c.ok){ const arr = await c.json(); const boxId = `comments-list-${idx}`; let box = document.getElementById(boxId); if(!box){ const d=document.createElement('div'); d.id=boxId; d.className='help'; document.querySelector(`#drawer-${idx} .body`).appendChild(d); box=d; }
          box.innerHTML = (arr.slice(0,5).map(x=>`• ${x.text}`).join('<br>')) || 'No comments yet'; }
      }catch(e){/* ignore */}
    }

    function localAvatarKey(){ return user && user.username ? 'avatar:'+user.username : null; }
    function setProfilePhoto(url){ const img=document.getElementById('pf-photo'); const av=document.getElementById('pf-avatar'); if(img){ img.src=url; img.style.display='block'; } if(av){ av.style.display='none'; } }
    function clearProfilePhoto(){ const img=document.getElementById('pf-photo'); const av=document.getElementById('pf-avatar'); if(img){ img.style.display='none'; img.src=''; } if(av){ av.style.display='grid'; } }
    async function tryLoadAvatar(){ if(!user){ clearProfilePhoto(); return; } const key=localAvatarKey(); if(key){ const data=localStorage.getItem(key); if(data){ setProfilePhoto(data); return;} } if(!useLive) return; const exts=['.png','.jpg','.jpeg','.webp']; for(const ext of exts){ const url=apiBase()+`/avatars/${user.id}${ext}`; const ok=await new Promise(r=>{ const im=new Image(); im.onload=()=>r(true); im.onerror=()=>r(false); im.src=url; }); if(ok){ setProfilePhoto(url); return; } } clearProfilePhoto(); }
    async function uploadAvatarFromInput(){ const inp=document.getElementById('pf-file'); if(!inp||!inp.files||!inp.files[0]) return alertMsg('Choose a photo first.'); const file=inp.files[0]; if(useLive && token){ try{ const fd=new FormData(); fd.append('file', file); const res=await fetch(apiBase()+"/me/avatar", {method:'POST', headers:{'Authorization':'Bearer '+token}, body:fd}); if(!res.ok) throw new Error('HTTP '+res.status); const data=await res.json(); const url=data && data.url ? (data.url.startsWith('http')?data.url:apiBase()+data.url) : null; if(url){ setProfilePhoto(url); successMsg('Profile photo updated.'); } }catch(e){ alertMsg('Upload failed: '+e.message); } } else { const r=new FileReader(); r.onload=()=>{ const k=localAvatarKey(); if(k){ localStorage.setItem(k, r.result); setProfilePhoto(r.result); successMsg('Photo saved locally.'); } }; r.readAsDataURL(file); } }
    async function refreshProfile(){ try{ const res=await fetch(apiBase()+"/me", { headers:{'Authorization':'Bearer '+token}}); if(!res.ok) throw new Error('HTTP '+res.status); user=await res.json(); document.getElementById('userPill').textContent='@'+user.username+' ('+user.role+')'; renderProfileHeader(); tryLoadAvatar(); prefillUpload(); renderMiniProfile(); tryLoadAvatarMini(); }catch(e){ user=null; document.getElementById('userPill').textContent='Not logged in'; clearProfilePhoto(); renderMiniProfile(); clearMiniPhoto(); } }

    function setView(view, el){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      if(el) el.classList.add('active');
      ['feed','auth','upload','profile'].forEach(v=>{
        const sec = document.getElementById('view-'+v);
        if(sec) sec.style.display = (v===view)?'block':'none';
      });
      if(view==='feed'){ reloadFeed(); }
      if(view==='profile'){ refreshProfile(); loadProfile(); }
    }

    let pfMenuOpen = false;
    function toggleProfileMenu(e){ e.stopPropagation(); const dd=document.getElementById('pf-menu'); if(!dd) return; const willOpen=!dd.classList.contains('open'); if(willOpen){ dd.classList.add('open'); document.addEventListener('click', hideProfileMenu, {once:true}); } else { dd.classList.remove('open'); } }
    function hideProfileMenu(){ const dd=document.getElementById('pf-menu'); if(dd) dd.classList.remove('open'); }
    function triggerAvatarFile(){ const inp=document.getElementById('pf-file'); if(inp) inp.click(); }
    async function copyProfileId(){ if(!(user && (user.id!==undefined))){ return alertMsg('No profile loaded.'); } try{ await navigator.clipboard.writeText(String(user.id)); successMsg('ID copied'); }catch(_){ successMsg('ID: '+user.id); } }

    function toggleMiniMenu(e){ e.stopPropagation(); const dd=document.getElementById('mini-menu'); if(!dd) return; const willOpen=!dd.classList.contains('open'); if(willOpen){ dd.classList.add('open'); document.addEventListener('click', hideMiniMenu, {once:true}); } else { dd.classList.remove('open'); } }
    function hideMiniMenu(){ const dd=document.getElementById('mini-menu'); if(dd) dd.classList.remove('open'); }
    function setMiniPhoto(url){ const img=document.getElementById('mini-photo'); const av=document.getElementById('mini-avatar'); if(img){ img.src=url; img.style.display='block'; } if(av){ av.style.display='none'; } }
    function clearMiniPhoto(){ const img=document.getElementById('mini-photo'); const av=document.getElementById('mini-avatar'); if(img){ img.style.display='none'; img.src=''; } if(av){ av.style.display='grid'; } }
    function renderMiniProfile(){ const name = user && user.username ? '@'+user.username : '@guest'; const av=document.getElementById('mini-avatar'); const nm=document.getElementById('mini-name'); if(av){ av.textContent = initials(user?user.username:'VB'); } if(nm){ nm.textContent = name; }
      const logged = !!user; const show=(id,on)=>{ const el=document.getElementById(id); if(el) el.style.display = on?'flex':'none'; };
      show('mm-login', !logged); show('mm-logout', logged); show('mm-change-photo', logged);
    }
    async function tryLoadAvatarMini(){ if(!user){ clearMiniPhoto(); return; } const exts=['.png','.jpg','.jpeg','.webp']; for(const ext of exts){ const url=apiBase()+`/avatars/${user.id}${ext}`; const ok=await new Promise(r=>{ const im=new Image(); im.onload=()=>r(true); im.onerror=()=>r(false); im.src=url; }); if(ok){ setMiniPhoto(url); return; } } clearMiniPhoto(); }

    (function selfTest(){
      try{
        console.assert(typeof toggleMiniMenu === 'function', 'toggleMiniMenu should be defined');
        console.assert(typeof setView === 'function', 'setView should be defined');
        console.assert(typeof prefillUpload === 'function', 'prefillUpload should be defined');
      }catch(err){ console.warn('Self-test warning:', err); }
    })();
  </script>
</body>
</html>
